/*
 * jQT 1.0-rc1
 * A jQuery plugin for TotalCheck
 * http://www.totalcheck.com.au/
 *
 * Copyright (c) 2013 Sensis

 * Developer: Stuart Steel
 * stuart.steel@sensis.com.au
 *
 * Licensed same as jquery - under the terms of either the MIT License or the GPL Version 2 License
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * $Date: 2013-03-18   $
 * $Revision: 6 $
 */
"use strict";(function(g,h){var e,k,j,f,i,c;document.write("<script type='text/ejs' id='nameSuggest'><% for(var i=0; i < names.length; i++){ %><div class='jqt-suggestedItem jqt-suggestedName'><%=names[i] %></div><%} %><\/script>");document.write("<script type='text/ejs' id='addressSuggest'><% for(var i=0; i < resultList.length; i++){ %><div class='jqt-suggestedItem jqt-suggestedAddress jqt-wp-<%=resultList[i].whitePages %>' attr-index='<%=resultList[i].index %>'><%=resultList[i].formattedAddress %></div><%} %><\/script>");document.write("<script type='text/ejs' id='subAddressSuggest'><% for(var i=0; i < detailList.length; i++){ %><div class='jqt-suggestedItem jqt-suggestedSubAddress' attr-index='<%=i %>'><%=detailList[i].formattedAddress %></div><%} %><\/script>");var b=0;var a=function(){this.defaults={address:{singleInput:false,searchType:"BOTH",eventTrigger:"keypress"},mobile:{eventTrigger:"blur"},email:{eventTrigger:"blur"},config:{delay:500,debug:false,ajaxRequest:"GET"}};this.configure=function(l){var m={address:"",mobile:"",email:"",config:""};m.address=g.extend(this.defaults.address,l.address);m.mobile=g.extend(this.defaults.mobile,l.mobile);m.email=g.extend(this.defaults.email,l.email);m.config=g.extend(this.defaults.config,l.config);return m}};var d={init:function(m){var l=g().jquery.replace(/^(.*)\.\d+$/,"$1");if(l<1.7){h.alert("jQT requires jQuery Version 1.7 or greater.\nCurrent version is "+g().jquery);return}this.settings=new a().configure(m);this.$ajax=(this.settings.config.ajaxRequest.toLowerCase()==="get")?g.get:g.post;this.jqt("eventBinding",this);return this},eventBinding:function(l){g(h.document).click(function(){g("#jqt-autocomplete").remove()});l.find(":text").on("focus.jqt",g.proxy(function(n){g("#jqt-autocomplete").remove();this.jqt("deleteKeyPressEvents",l);j=n.target.id},l));l.on("mouseenter.jqt",".jqt-suggestedItem",g.proxy(function(n){this.find(".jqt-active").removeClass("jqt-active");g(n.target).addClass("jqt-active")},l));if(l.settings.config.reset){g(l.settings.config.reset).click(g.proxy(function(n){this.jqt("reset",this)},l))}if(l.settings.address&&l.settings.address.inputs){g.each(l.settings.address.inputs,function(o,n){var q,s,r;q=g(n).attr("autocomplete","off");if(q.length===0){console.error("element "+this+" not found");return}s=q.parent();if(s.length>0){if(s[0].nodeName==="TD"){s.append("<div style='position: relative;' />");r=s.children("div").last();r.append(s.children().not(r))}else{s.css("position","relative")}}});if(l.settings.address.inputs.primaryName){g(l.settings.address.inputs.primaryName).keyup(function(n){if(n.keyCode===37||n.keyCode===38||n.keyCode===39||n.keyCode===40||n.keyCode===13){return}var o=this;if(o.value.length>2){l.delay(l.settings.config.delay).queue(function(){l.jqt("suggestName",o,l);l.clearQueue()})}})}l.on("click.jqt",".jqt-suggestedName",function(){l.jqt("selectName",this,l)});var m="";g.each(l.settings.address.inputs,function(o,n){if(o==="primaryName"||o==="submit"){return}if(m!==""){m+=","}m+=n});if(l.settings.address.eventTrigger==="keypress"){g(m).keypress(function(n){if(n.keyCode===37||n.keyCode===38||n.keyCode===39||n.keyCode===40||n.keyCode===13){return}var o=this;var p=("#"+o.id===l.settings.address.inputs.phonenumber)?5:2;if(o.value.length>p){l.delay(l.settings.config.delay).queue(function(){l.jqt("suggestAddress",o,l);l.clearQueue()})}})}else{if(l.settings.address.eventTrigger==="click"&&l.settings.address.inputs.submit){g(l.settings.address.inputs.submit).click(function(n){var o=(l.settings.address.inputs.submitTarget)?g(l.settings.address.inputs.submitTarget):this;l.jqt("suggestAddress",o,l)})}}l.on("click.jqt",".jqt-suggestedAddress",function(){l.jqt("selectAddress",this,l)});l.on("click.jqt",".jqt-suggestedSubAddress",function(){l.jqt("selectSubAddress",this,l)})}if(l.settings.mobile&&l.settings.mobile.inputs&&l.settings.mobile.inputs.number){if(l.settings.mobile.eventTrigger==="blur"){g(l.settings.mobile.inputs.number).blur(function(){l.jqt("validateMobile",l)})}else{if(l.settings.mobile.eventTrigger==="click"&&l.settings.mobile.inputs.submit){g(l.settings.mobile.inputs.submit).click(function(){l.jqt("validateMobile",l)})}}}if(l.settings.email&&l.settings.email.inputs&&l.settings.email.inputs.email){if(l.settings.email.eventTrigger==="blur"){g(l.settings.email.inputs.email).blur(function(){l.jqt("validateEmail",l)})}else{if(l.settings.email.eventTrigger==="click"&&l.settings.email.inputs.submit){g(l.settings.email.inputs.submit).click(function(){l.jqt("validateEmail",l)})}}}},suggestName:function(q,s){b++;var o=s.settings.address.ajax.suggestName;var n,r,p,l,m={names:[]};l=g(q);l.val(l.val().replace(/\d/g,"")).addClass("jqt-ajaxLoading");r=l.val();p="full details";n={surname:r,search:p,request_n:b,action:"SuggestName"};s.trigger({type:"preRequest.jqt",request:n,instance:s});s.$ajax(o,n,function(u){if(u.request_n<b){return}var t=u["return"];if(t){s.trigger({type:"namesSuggested.jqt",request:n,response:t,instance:s});if(typeof totalcheck=="string"){m.names.push(t)}else{g.each(t,function(){m.names.push(this)})}s.jqt("autoComplete",s.settings.address.outputs.primaryName,m,"nameSuggest");s.trigger({type:"namesPublished.jqt",request:n,response:t,instance:s})}else{s.find("input.jqt-ajaxLoading").removeClass("jqt-ajaxLoading")}},"json")},selectName:function(l,m){g(m.settings.address.inputs.primaryName).val(g(l).text());m.trigger({type:"nameSelected.jqt",el:l,instance:m})},suggestAddress:function(n,o){var p;b++;var m=o.settings.address.ajax.suggestAddress;f=g(n);var l={searchType:o.settings.address.searchType,singleInput:o.settings.address.singleInput,request_n:b,action:"SuggestAddress"};g.each(o.settings.address.inputs,function(r,q){p=g(q).val();if(!(p===null||p===undefined)){l[r]=p}});g(n).addClass("jqt-ajaxLoading");o.trigger({type:"preRequest.jqt",request:l,instance:o});o.$ajax(m,l,function(r){if(r.request_n<b){return}var q=r["return"];if(q&&q.resultList){if(q.resultStatus==1){i=q;o.trigger({type:"addressesSuggested.jqt",request:l,response:q,instance:o});if(q.resultList.formattedAddress){o.jqt("autoComplete",f,{resultList:[q.resultList]},"addressSuggest");i.resultList=[q.resultList]}else{o.jqt("autoComplete",f,q,"addressSuggest")}o.trigger({type:"addressesPublished.jqt",request:l,response:q,instance:o})}else{if(q.resultStatus==3){o.find("input.jqt-ajaxLoading").removeClass("jqt-ajaxLoading")}}}else{if(q&&q.resultStatus==2){o.find("input.jqt-ajaxLoading").removeClass("jqt-ajaxLoading")}else{if(q&&q.resultStatus==3){o.find("input.jqt-ajaxLoading").removeClass("jqt-ajaxLoading")}}}},"json")},selectAddress:function(o,p){var q,m,n,l;g.each(p.settings.address.inputs,function(){g(this).addClass("jqt-ajaxLoading")});m=p.settings.address.ajax.selectAddress;if(i&&i.resultList&&g(o).attr("attr-index")>0){n=i.resultList[g(o).attr("attr-index")]}else{n={formattedAddress:"",index:0,whitePages:false,postal:true}}l={formattedAddress:n.formattedAddress,searchType:p.settings.address.searchType,singleInput:p.settings.address.singleInput,index:n.index,whitePages:n.whitePages,postal:n.postal,action:"SelectAddress"};g.each(p.settings.address.inputs,function(s,r){q=g(r).val();if(!(q===null||q===undefined)){l[s]=q}});p.trigger({type:"preRequest.jqt",el:o,request:l,instance:p});g("#jqt-autocomplete").remove();p.jqt("deleteKeyPressEvents",p);p.$ajax(m,l,function(s){p.find("input.jqt-ajaxLoading").removeClass("jqt-ajaxLoading");var r=s["return"];if(r&&r.resultStatus==1){p.trigger({type:"addressSupplied.jqt",request:l,response:r,instance:p});c=r;if(r.detailList&&r.detailList.length>1){p.jqt("autoComplete",f,r,"subAddressSuggest");p.trigger({type:"subAddressesPublished.jqt",request:l,response:r,instance:p})}else{p.jqt("publishAddress",r,p)}}else{if(r&&r.resultStatus==2){console.log("No matching results")}else{if(r&&r.resultStatus==3){console.log("too many matching results")}else{if(r&&r.resultStatus==4){p.trigger({type:"addressCheckFails.jqt",request:l,response:r,instance:p});console.log("request mismatch")}}}}},"json")},selectSubAddress:function(m,n){var l=g.extend(c,c.detailList[g(m).attr("attr-index")]);n.trigger({type:"subAddressSelected.jqt",el:m,address:l,instance:n});n.jqt("publishAddress",l,n)},validateEmail:function(o){var n=o.settings.email.ajax;var m,l;l=g(o.settings.email.inputs.email).val();if(l===""){return}m={email:l,action:"ValidateEmail"};o.trigger({type:"preRequest.jqt",request:m,instance:o});g(o.settings.email.inputs.email).addClass("jqt-ajaxLoading");o.$ajax(n,m,function(q){var p=q["return"];if(p){if(p.doesEmailExist&&p.cleanEmail){if(o.settings.email.outputs){g.each(o.settings.email.outputs,function(s,r){o.jqt("publishDetail",o.settings.email.outputs[s],p[s])})}o.trigger({type:"emailValidated.jqt",response:p,instance:o})}else{o.trigger({type:"emailFailed.jqt",response:p,instance:o})}o.trigger({type:"emailTested.jqt",response:p,instance:o});o.find(".jqt-ajaxLoading").removeClass("jqt-ajaxLoading")}},"json")},validateMobile:function(o){var n=o.settings.mobile.ajax;var m,l;l=g(o.settings.mobile.inputs.number).val();if(l===""){return}m={number:l,action:"ValidateMobile"};o.trigger({type:"preRequest.jqt",request:m,instance:o});g(o.settings.mobile.inputs.number).addClass("jqt-ajaxLoading");o.$ajax(n,m,function(q){var p=q["return"];if(p){if(p.response&&p.cleanNumber){if(o.settings.mobile.outputs){g.each(o.settings.mobile.outputs,function(s,r){o.jqt("publishDetail",o.settings.mobile.outputs[s],p[s])})}o.trigger({type:"mobileValidated.jqt",response:p,instance:o})}else{o.trigger({type:"mobileFailed.jqt",response:p,instance:o})}o.trigger({type:"mobileTested.jqt",response:p,instance:o});o.find(".jqt-ajaxLoading").removeClass("jqt-ajaxLoading")}},"json")},publishAddress:function(n,m){var l="";if(n.subPremise){l+=n.subPremise+", "}if(n.streetNumber){l+=n.streetNumber+" "}if(n.streetName){l+=n.streetName+" "}if(n.streetType){l+=n.streetType}n.address=l;g.each(m.settings.address.outputs,function(p,o){m.jqt("publishDetail",o,n[p])});m.trigger({type:"addressPublished.jqt",address:n,instance:m})},publishEmail:function(){},publishMobile:function(){},publishDetail:function(l,n){var m=g(l);if(m.length===1){if(m[0].type){m.val(n)}else{m.html(n)}}},autoComplete:function(r,q,o){var l,m,p,n;g("#jqt-autocomplete").remove();this.jqt("deleteKeyPressEvents",this);this.find(".jqt-ajaxLoading").removeClass("jqt-ajaxLoading");this.find(".jqt-active").removeClass("jqt-active");l=g(r);var s=l.parent().addClass("jqt-active");s.append("<div id='jqt-autocomplete'></div>");g("#jqt-autocomplete").css("left",l.position().left).append(o,q).find(".jqt-suggestedItem").eq(0).addClass("jqt-active");this.jqt("setKeyPressEvents",this);this.trigger({type:"autoComplete.jqt",data:q,instance:this})},setKeyPressEvents:function(l){l.on("keydown.jqt-kp",function(m){var p,n,o;if(m.keyCode===38){p=g("#jqt-autocomplete .jqt-active");o=p.prev();if(o.length>0){o.addClass("jqt-active");p.removeClass("jqt-active");l.jqt("scrollActiveOption",o);return false}}else{if(m.keyCode===40){p=g("#jqt-autocomplete .jqt-active");n=p.next();if(n.length>0){n.addClass("jqt-active");p.removeClass("jqt-active");l.jqt("scrollActiveOption",n);return false}}else{if(m.keyCode===13){p=g("#jqt-autocomplete .jqt-active");if(p.length>0){p.trigger("click");return false}}}}})},deleteKeyPressEvents:function(l){l.off("keydown.jqt-kp")},scrollActiveOption:function(n){var r,q,m,o,l;r=n.parent();q=r.height();o=r.scrollTop();l=n.position().top;m=n.height();if((l+0.5*m)>q){r.scrollTop(l+0.5*m+o-0.5*q)}else{if(l<0){r.scrollTop(r.scrollTop()-r.height()*0.5-0.5*m)}}},reset:function(l){g("#jqt-autocomplete").remove();if(l.settings.address!==undefined&&l.settings.address.outputs!==undefined){g.each(l.settings.address.outputs,function(n,m){l.jqt("publishDetail",m,"",l)})}},ajaxFailure:function(l){g(".jqt-ajaxLoading").removeClass("jqt-ajaxLoading");console.error(l)},error:function(){}};g.fn.jqt=function(l){if(d[l]){return d[l].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof l==="object"||!l){return d.init.apply(this,arguments)}else{g.error("Method "+l+" does not exist on jQuery.jqt")}}}})(jQuery,window);